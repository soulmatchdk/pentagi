services:
  neo4j:
    image: neo4j:5.26.2
    restart: unless-stopped

    # Ingen container_name (undgår conflicts ved redeploy)
    # container_name: neo4j

    environment:
      NEO4J_AUTH: "${NEO4J_USER:-neo4j}/${NEO4J_PASSWORD:-devpassword}"

      # konservativ memory (valgfrit)
      NEO4J_server_memory_heap_initial__size: "${NEO4J_HEAP_INIT:-512m}"
      NEO4J_server_memory_heap_max__size: "${NEO4J_HEAP_MAX:-1g}"
      NEO4J_server_memory_pagecache_size: "${NEO4J_PAGECACHE:-512m}"

    volumes:
      - neo4j_data:/data

    networks:
      - pentagi-network

    # Expose internt (ingen behov for host-binding)
    expose:
      - "7474"
      - "7687"

    # Healthcheck uden wget/curl: test at 7474 accepterer TCP
    healthcheck:
      test: ["CMD-SHELL", "bash -lc 'echo > /dev/tcp/127.0.0.1/7474'"]
      interval: 5s
      timeout: 5s
      retries: 60
      start_period: 60s

  graphiti:
    image: vxcontrol/graphiti:latest
    restart: unless-stopped

    # Ingen container_name
    # container_name: graphiti

    depends_on:
      neo4j:
        condition: service_healthy

    environment:
      NEO4J_URI: "${NEO4J_URI:-bolt://neo4j:7687}"
      NEO4J_USER: "${NEO4J_USER:-neo4j}"
      NEO4J_PASSWORD: "${NEO4J_PASSWORD:-devpassword}"
      NEO4J_DATABASE: "${NEO4J_DATABASE:-neo4j}"

      MODEL_NAME: "${GRAPHITI_MODEL_NAME:-minimax-m2.5-free}"

      OPENAI_BASE_URL: "${OPEN_AI_SERVER_URL:-https://api.openai.com/v1}"
      OPENAI_API_KEY: "${OPEN_AI_KEY:-}"

      PORT: "8000"

    # Host-port: brug 18000 så du undgår 8000 konflikt
    ports:
      - "127.0.0.1:${GRAPHITI_PORT:-18000}:8000"

    networks:
      - pentagi-network

    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; urllib.request.urlopen('http://127.0.0.1:8000/healthcheck', timeout=2).read()\""]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 30s

volumes:
  neo4j_data:
    driver: local

networks:
  pentagi-network:
    external: false
